<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Användarinformation</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #1DB954;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            overflow-y: scroll;
            padding: 20px;
        }
        .container {
            text-align: center;
            background-color: #191414;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 800px;
            overflow-y: auto;
            max-height: 80vh;
        }
        .spotify-logo {
            width: 100px;
            margin-bottom: 20px;
        }
        .likes, .profile, .playlists, .top-tracks, .top-artists, .related-artists, .following, .most-played, .subscription {
            margin: 20px 0;
            font-size: 18px;
        }
        .profile img {
            border-radius: 50%;
            width: 50px;
            height: 50px;
        }
        button {
            background-color: #1DB954;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 10px 15px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
        }
        button:hover {
            background-color: #1aa34a;
        }
    </style>
</head>
<body>

    <div class="container">
        <img src="https://upload.wikimedia.org/wikipedia/commons/2/26/Spotify_logo_with_text.svg" alt="Spotify Logo" class="spotify-logo">
        <div class="profile" id="profile" style="display: none;"></div>
        <div class="subscription" id="subscription" style="display: none;"></div>
        <div id="likes" class="likes" style="display: none;">Gillade låtar: </div>
        <div id="playlists" class="playlists" style="display: none;">Spellistor: </div>
        <div id="topTracks" class="top-tracks" style="display: none;">Topp låtar: </div>
        <div id="top-artists" class="top-artists" style="display: none;">Topp artister: </div>
        <div id="related-artists" class="related-artists" style="display: none;">Relaterade artister: </div>
        <div id="following" class="following" style="display: none;">Följande: </div>
        <div id="mostPlayed" class="most-played" style="display: none;">Mest spelade låt: </div>
        <button id="loginButton">Logga in med Spotify</button>
        <button id="logoutButton" style="display:none;">Logga ut</button>
    </div>

    <script>
        const clientId = '298808efdd1e4b3d81af791afdcf1b9d'; // Ersätt med din Spotify Client ID
        const redirectUri = window.location.href; // Använd nuvarande URL som redirect
        const authEndpoint = 'https://accounts.spotify.com/authorize';
        const scopes = [
            'user-library-read',
            'playlist-read-private',
            'user-top-read',
            'user-read-private',
            'user-follow-read',
            'user-read-playback-state',
            'user-read-currently-playing'
        ]; // Behörigheter för att läsa användardata

        const loginButton = document.getElementById('loginButton');
        const logoutButton = document.getElementById('logoutButton');
        const likesElement = document.getElementById('likes');
        const profileElement = document.getElementById('profile');
        const playlistsElement = document.getElementById('playlists');
        const topTracksElement = document.getElementById('topTracks');
        const topArtistsElement = document.getElementById('top-artists');
        const relatedArtistsElement = document.getElementById('related-artists');
        const followingElement = document.getElementById('following');
        const mostPlayedElement = document.getElementById('mostPlayed');
        const subscriptionElement = document.getElementById('subscription');

        // Funktion för att logga in användaren
        loginButton.addEventListener('click', () => {
            const url = `${authEndpoint}?client_id=${clientId}&redirect_uri=${encodeURIComponent(redirectUri)}&scope=${encodeURIComponent(scopes.join(' '))}&response_type=token&show_dialog=true`;
            window.location = url;
        });

        // Funktion för att logga ut användaren
        logoutButton.addEventListener('click', () => {
            const username = profileElement.querySelector('div').textContent; // Anta att profilnamnet är användarnamn
            logout(username);
        });

        // Funktion för att extrahera access_token från URL efter inloggning
        function getAccessToken() {
            const hash = window.location.hash;
            if (hash) {
                const params = new URLSearchParams(hash.substring(1));
                const token = params.get('access_token');
                const username = params.get('state'); // Användarnamnet skickas som state
                if (token) {
                    saveAccessToken(token, username); // Spara token med användarnamn som nyckel
                }
                window.history.pushState("", document.title, window.location.pathname); // Rensa URL
                return token;
            }
            return null; // Ingen token finns
        }

        // Spara access token med användarnamn som nyckel
        function saveAccessToken(token, username) {
            localStorage.setItem(`access_token_${username}`, token);
        }

        // Hämta access token baserat på användarnamn
        function getAccessTokenForUser(username) {
            return localStorage.getItem(`access_token_${username}`);
        }

        // Logga ut och rensa token
        function logout(username) {
            localStorage.removeItem(`access_token_${username}`);
            window.location.reload(); // Ladda om sidan
        }

        // Funktion för att hämta och visa användardata
        async function getUserData(token) {
            // Hämta användarens profilinformation
            const profileResponse = await fetch('https://api.spotify.com/v1/me', {
                headers: {
                    Authorization: `Bearer ${token}`
                }
            });
            const profileData = await profileResponse.json();
            profileElement.innerHTML = `
                <img src="${profileData.images[0]?.url}" alt="Profilbild">
                <div>${profileData.display_name}</div>
            `;
            profileElement.style.display = 'block'; // Visa profilbild och namn
            
            // Hämta abonnemangsnivå
            subscriptionElement.innerHTML = `Prenumeration: ${profileData.product}`;
            subscriptionElement.style.display = 'block'; // Visa abonnemangsnivå

            // Hämta och visa antalet gillade låtar
            const likesResponse = await fetch('https://api.spotify.com/v1/me/tracks', {
                headers: {
                    Authorization: `Bearer ${token}`
                }
            });
            const likesData = await likesResponse.json();
            likesElement.textContent = `Gillade låtar: ${likesData.total}`;
            likesElement.style.display = 'block'; // Visa gillade låtar

            // Hämta spellistor
            const playlistsResponse = await fetch('https://api.spotify.com/v1/me/playlists', {
                headers: {
                    Authorization: `Bearer ${token}`
                }
            });
            const playlistsData = await playlistsResponse.json();
            playlistsElement.innerHTML = `Spellistor: ${playlistsData.items.length}`;
            playlistsElement.style.display = 'block'; // Visa spellistor
            playlistsData.items.forEach(playlist => {
                playlistsElement.innerHTML += `<div>${playlist.name}</div>`;
            });

            // Hämta topp låtar
            const topTracksResponse = await fetch('https://api.spotify.com/v1/me/top/tracks', {
                headers: {
                    Authorization: `Bearer ${token}`
                }
            });
            const topTracksData = await topTracksResponse.json();
            if (topTracksData.items.length > 0) {
                topTracksElement.innerHTML = `Topp låtar: ${topTracksData.items.length}`;
                topTracksElement.style.display = 'block'; // Visa topp låtar
                topTracksData.items.forEach(track => {
                    topTracksElement.innerHTML += `<div>${track.name} - ${track.artists[0].name}</div>`;
                });
            } else {
                topTracksElement.textContent = 'Inga topp låtar tillgängliga.';
                topTracksElement.style.display = 'block'; // Visa topp låtar
            }

            // Hämta topp artister
            const topArtistsResponse = await fetch('https://api.spotify.com/v1/me/top/artists', {
                headers: {
                    Authorization: `Bearer ${token}`
                }
            });
            const topArtistsData = await topArtistsResponse.json();
            if (topArtistsData.items.length > 0) {
                topArtistsElement.innerHTML = `Topp artister: ${topArtistsData.items.length}`;
                topArtistsElement.style.display = 'block'; // Visa topp artister
                topArtistsData.items.forEach(artist => {
                    topArtistsElement.innerHTML += `<div>${artist.name}</div>`;
                });
            } else {
                topArtistsElement.textContent = 'Inga topp artister tillgängliga.';
                topArtistsElement.style.display = 'block'; // Visa topp artister
            }

            // Hämta relaterade artister
            const relatedArtistsResponse = await fetch(`https://api.spotify.com/v1/artists/${topArtistsData.items[0].id}/related-artists`, {
                headers: {
                    Authorization: `Bearer ${token}`
                }
            });
            const relatedArtistsData = await relatedArtistsResponse.json();
            if (relatedArtistsData.artists.length > 0) {
                relatedArtistsElement.innerHTML = `Relaterade artister: ${relatedArtistsData.artists.length}`;
                relatedArtistsElement.style.display = 'block'; // Visa relaterade artister
                relatedArtistsData.artists.forEach(artist => {
                    relatedArtistsElement.innerHTML += `<div>${artist.name}</div>`;
                });
            } else {
                relatedArtistsElement.textContent = 'Inga relaterade artister tillgängliga.';
                relatedArtistsElement.style.display = 'block'; // Visa relaterade artister
            }

            // Hämta följande
            const followingResponse = await fetch('https://api.spotify.com/v1/me/following?type=artist', {
                headers: {
                    Authorization: `Bearer ${token}`
                }
            });
            const followingData = await followingResponse.json();
            followingElement.innerHTML = `Följande: ${followingData.artists.items.length}`;
            followingElement.style.display = 'block'; // Visa följande
            followingData.artists.items.forEach(artist => {
                followingElement.innerHTML += `<div>${artist.name}</div>`;
            });

            // Hämta mest spelade låt
            const mostPlayedResponse = await fetch('https://api.spotify.com/v1/me/top/tracks?limit=1', {
                headers: {
                    Authorization: `Bearer ${token}`
                }
            });
            const mostPlayedData = await mostPlayedResponse.json();
            if (mostPlayedData.items.length > 0) {
                mostPlayedElement.innerHTML = `Mest spelade låt: ${mostPlayedData.items[0].name} - ${mostPlayedData.items[0].artists[0].name}`;
                mostPlayedElement.style.display = 'block'; // Visa mest spelade låt
            } else {
                mostPlayedElement.textContent = 'Ingen mest spelade låt tillgänglig.';
                mostPlayedElement.style.display = 'block'; // Visa mest spelade låt
            }
        }

        // Hämta användardata efter inloggning
        window.onload = () => {
            const token = getAccessToken();
            const username = prompt('Ange ditt användarnamn:'); // Fråga om användarnamn vid inloggning
            if (token) {
                saveAccessToken(token, username); // Spara token
                getUserData(token); // Hämta användardata
                loginButton.style.display = 'none'; // Dölj inloggningsknappen
                logoutButton.style.display = 'block'; // Visa utloggningsknappen
            }
        };
    </script>
</body>
</html>
